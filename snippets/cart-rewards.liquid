{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
CART REWARDS
----------------------------------------------------------------------------------------------------------------------
Renders up to 4 spend-based milestones in the cart drawer.
Each milestone can be type "shipping" (visual only) or "gift" (auto-adds a product).
----------------------------------------------------------------------------------------------------------------------
{%- endcomment -%}

{%- liquid
  assign calculated_total_price = 0

  for line_item in cart.items
    if line_item.requires_shipping
      assign calculated_total_price = calculated_total_price | plus: line_item.final_line_price
    endif
  endfor

  assign total_cart_discount = 0

  for discount_application in cart.cart_level_discount_applications
    assign total_cart_discount = total_cart_discount | plus: discount_application.total_allocated_amount
  endfor

  assign calculated_total_price = calculated_total_price | minus: total_cart_discount

  assign rewards_all_unlocked = settings.rewards_all_unlocked_subtitle | default: 'You have unlocked all rewards!'

  assign r1_type = settings.reward_1_type | default: 'shipping'
  assign r1_threshold = settings.reward_1_threshold | default: '' | plus: 0 | times: 100
  assign r1_label = settings.reward_1_label | default: ''
  assign r1_message = settings.reward_1_message | default: 'Spend [amount_left] more to receive [reward]!'
  assign r1_product = settings.reward_1_product

  assign r2_type = settings.reward_2_type | default: 'shipping'
  assign r2_threshold = settings.reward_2_threshold | default: '' | plus: 0 | times: 100
  assign r2_label = settings.reward_2_label | default: ''
  assign r2_message = settings.reward_2_message | default: 'Spend [amount_left] more to receive [reward]!'
  assign r2_product = settings.reward_2_product

  assign r3_type = settings.reward_3_type | default: 'gift'
  assign r3_threshold = settings.reward_3_threshold | default: '' | plus: 0 | times: 100
  assign r3_label = settings.reward_3_label | default: ''
  assign r3_message = settings.reward_3_message | default: 'Spend [amount_left] more to receive [reward]!'
  assign r3_product = settings.reward_3_product

  assign r4_type = settings.reward_4_type | default: 'gift'
  assign r4_threshold = settings.reward_4_threshold | default: '' | plus: 0 | times: 100
  assign r4_label = settings.reward_4_label | default: ''
  assign r4_message = settings.reward_4_message | default: 'Spend [amount_left] more to receive [reward]!'
  assign r4_product = settings.reward_4_product

  assign milestones_count = 0
  assign max_threshold = 0

  if r1_threshold > 0
    assign milestones_count = milestones_count | plus: 1
    if r1_threshold > max_threshold
      assign max_threshold = r1_threshold
    endif
  endif
  if r2_threshold > 0
    assign milestones_count = milestones_count | plus: 1
    if r2_threshold > max_threshold
      assign max_threshold = r2_threshold
    endif
  endif
  if r3_threshold > 0
    assign milestones_count = milestones_count | plus: 1
    if r3_threshold > max_threshold
      assign max_threshold = r3_threshold
    endif
  endif
  if r4_threshold > 0
    assign milestones_count = milestones_count | plus: 1
    if r4_threshold > max_threshold
      assign max_threshold = r4_threshold
    endif
  endif
-%}

{%- if milestones_count > 0 -%}
  <cart-rewards
    class="cart-rewards"
    data-total-price="{{ calculated_total_price }}"
    data-max-threshold="{{ max_threshold }}"
    data-all-unlocked-subtitle="{{ rewards_all_unlocked | escape }}"
  >
    <p class="cart-rewards__message" data-rewards-message></p>

    <div class="cart-rewards__bar-row">
      {%- comment -%} Start circle {%- endcomment -%}
      <span class="cart-rewards__endpoint cart-rewards__endpoint--start"></span>

      <div class="cart-rewards__track">
        <span class="cart-rewards__fill"></span>
        <div class="cart-rewards__markers">
          {%- if r1_threshold > 0 -%}
            <span class="cart-rewards__marker" data-reward-marker data-threshold="{{ r1_threshold }}">
              <span class="cart-rewards__marker-icon">
                {%- if r1_type == 'shipping' -%}
                  <span class="svg-wrapper">{{- 'icon-truck.svg' | inline_asset_content -}}</span>
                {%- else -%}
                  <span class="svg-wrapper">{{- 'icon-gift.svg' | inline_asset_content -}}</span>
                {%- endif -%}
              </span>
            </span>
          {%- endif -%}
          {%- if r2_threshold > 0 -%}
            <span class="cart-rewards__marker" data-reward-marker data-threshold="{{ r2_threshold }}">
              <span class="cart-rewards__marker-icon">
                {%- if r2_type == 'shipping' -%}
                  <span class="svg-wrapper">{{- 'icon-truck.svg' | inline_asset_content -}}</span>
                {%- else -%}
                  <span class="svg-wrapper">{{- 'icon-gift.svg' | inline_asset_content -}}</span>
                {%- endif -%}
              </span>
            </span>
          {%- endif -%}
          {%- if r3_threshold > 0 -%}
            <span class="cart-rewards__marker" data-reward-marker data-threshold="{{ r3_threshold }}">
              <span class="cart-rewards__marker-icon">
                {%- if r3_type == 'shipping' -%}
                  <span class="svg-wrapper">{{- 'icon-truck.svg' | inline_asset_content -}}</span>
                {%- else -%}
                  <span class="svg-wrapper">{{- 'icon-gift.svg' | inline_asset_content -}}</span>
                {%- endif -%}
              </span>
            </span>
          {%- endif -%}
          {%- if r4_threshold > 0 -%}
            <span class="cart-rewards__marker" data-reward-marker data-threshold="{{ r4_threshold }}">
              <span class="cart-rewards__marker-icon">
                {%- if r4_type == 'shipping' -%}
                  <span class="svg-wrapper">{{- 'icon-truck.svg' | inline_asset_content -}}</span>
                {%- else -%}
                  <span class="svg-wrapper">{{- 'icon-gift.svg' | inline_asset_content -}}</span>
                {%- endif -%}
              </span>
            </span>
          {%- endif -%}
        </div>
      </div>

      {%- comment -%} End circle {%- endcomment -%}
      <span class="cart-rewards__endpoint cart-rewards__endpoint--end"></span>
    </div>

    {%- comment -%} Hidden data rows consumed by JS {%- endcomment -%}
    <div class="cart-rewards__milestones">
      {%- if r1_threshold > 0 -%}
        <div class="cart-rewards__milestone"
          data-reward-milestone
          data-threshold="{{ r1_threshold }}"
          data-type="{{ r1_type }}"
          data-message="{{ r1_message | escape }}"
          data-gift-key="reward-1"
          {%- if r1_type == 'gift' and r1_product != blank %} data-variant-id="{{ r1_product.selected_or_first_available_variant.id }}"{% endif -%}
        >
          <span class="cart-rewards__label">{{ r1_label }}</span>
        </div>
      {%- endif -%}
      {%- if r2_threshold > 0 -%}
        <div class="cart-rewards__milestone"
          data-reward-milestone
          data-threshold="{{ r2_threshold }}"
          data-type="{{ r2_type }}"
          data-message="{{ r2_message | escape }}"
          data-gift-key="reward-2"
          {%- if r2_type == 'gift' and r2_product != blank %} data-variant-id="{{ r2_product.selected_or_first_available_variant.id }}"{% endif -%}
        >
          <span class="cart-rewards__label">{{ r2_label }}</span>
        </div>
      {%- endif -%}
      {%- if r3_threshold > 0 -%}
        <div class="cart-rewards__milestone"
          data-reward-milestone
          data-threshold="{{ r3_threshold }}"
          data-type="{{ r3_type }}"
          data-message="{{ r3_message | escape }}"
          data-gift-key="reward-3"
          {%- if r3_type == 'gift' and r3_product != blank %} data-variant-id="{{ r3_product.selected_or_first_available_variant.id }}"{% endif -%}
        >
          <span class="cart-rewards__label">{{ r3_label }}</span>
        </div>
      {%- endif -%}
      {%- if r4_threshold > 0 -%}
        <div class="cart-rewards__milestone"
          data-reward-milestone
          data-threshold="{{ r4_threshold }}"
          data-type="{{ r4_type }}"
          data-message="{{ r4_message | escape }}"
          data-gift-key="reward-4"
          {%- if r4_type == 'gift' and r4_product != blank %} data-variant-id="{{ r4_product.selected_or_first_available_variant.id }}"{% endif -%}
        >
          <span class="cart-rewards__label">{{ r4_label }}</span>
        </div>
      {%- endif -%}
    </div>
  </cart-rewards>

  <script>
    if (!window.customElements.get('cart-rewards')) {
      class CartRewards extends HTMLElement {
        constructor() {
          super();
          this._onCartChange = this._onCartChange.bind(this);
          this._onCartRefresh = this._onCartRefresh.bind(this);
          this._currencyFormatter = new Intl.NumberFormat(Shopify.locale, {
            style: 'currency',
            currency: Shopify.currency.active
          });
          this._giftSyncInProgress = false;
          this._pendingGiftAdds = new Set();
          this._tagCache = new Map();
          this._isExcluded = false;
          this._refreshFallbackTriggered = false;
          this._syncTimer = null;
          this._pendingCart = null;
          this._pendingTotal = 0;
        }

        connectedCallback() {
          document.addEventListener('cart:change', this._onCartChange);
          document.addEventListener('cart:refresh', this._onCartRefresh);
          this._bootstrap();
        }

        disconnectedCallback() {
          document.removeEventListener('cart:change', this._onCartChange);
          document.removeEventListener('cart:refresh', this._onCartRefresh);
        }

        async _bootstrap() {
          const cart = await this._fetchCart();
          void this._updateFromCart(cart);
        }

        async _onCartRefresh() {
          const cart = await this._fetchCart();
          void this._updateFromCart(cart);
        }

        _onCartChange(event) {
          if (!event.detail || !event.detail.cart) return;
          void this._updateFromCart(event.detail.cart);
        }

        async _fetchCart() {
          const response = await fetch(`${Shopify.routes.root}cart.js`, { credentials: 'same-origin' });
          return response.json();
        }

        _calculateTotal(cart) {
          const priceForItems = (cart.items || [])
            .filter((item) => item.requires_shipping)
            .reduce((sum, item) => sum + item.final_line_price, 0);
          const cartDiscount = (cart.cart_level_discount_applications || [])
            .reduce((sum, discountAllocation) => sum + discountAllocation.total_allocated_amount, 0);
          return priceForItems - cartDiscount;
        }

        _formatMoney(cents) {
          return this._currencyFormatter.format(cents / 100);
        }

        async _updateFromCart(cart) {
          const total = this._calculateTotal(cart);
          this.dataset.totalPrice = total;
          this._updateProgress(total);
          this._updateMilestones(total);
          this._clearPendingGifts(cart.items || []);
          await this._updateExclusion(cart);
          this._pendingCart = cart;
          this._pendingTotal = total;
          this._scheduleGiftSync();
          this._ensureDrawerItems(cart);
        }

        _scheduleGiftSync() {
          if (this._syncTimer) {
            clearTimeout(this._syncTimer);
          }
          this._syncTimer = setTimeout(() => {
            this._syncTimer = null;
            if (!this._pendingCart) return;
            void this._syncGifts(this._pendingCart, this._pendingTotal);
          }, 250);
        }

        _ensureDrawerItems(cart) {
          const drawer = this.closest('cart-drawer');
          if (!drawer) return;

          const itemsContainer = drawer.querySelector('#CartDrawer-CartItems');
          if (!itemsContainer) return;

          const hasItems = itemsContainer.querySelectorAll('.cart-item').length > 0;
          const shouldHaveItems = (cart.item_count || 0) > 0;

          if (shouldHaveItems && !hasItems && !this._refreshFallbackTriggered) {
            this._refreshFallbackTriggered = true;
            document.dispatchEvent(new CustomEvent('cart:refresh'));
          } else if (hasItems) {
            this._refreshFallbackTriggered = false;
          }
        }

        async _updateExclusion(cart) {
          const items = cart.items || [];
          let hasExcluded = false;

          for (const item of items) {
            if (!item.handle) continue;
            const tags = await this._fetchProductTags(item.handle);
            if (tags.includes('exclude_rewards')) {
              hasExcluded = true;
              break;
            }
          }

          this._isExcluded = hasExcluded;
          document.documentElement.classList.toggle('has-exclude-rewards', hasExcluded);

          if (!hasExcluded) return;

          for (const item of items) {
            const properties = item.properties || {};
            if (properties.__reward_gift_variant || properties.__reward_gift) {
              await this._removeGift(item.key);
            }
          }
        }

        async _fetchProductTags(handle) {
          if (!handle) return [];
          if (this._tagCache.has(handle)) return this._tagCache.get(handle);

          const cacheKey = `tags_${handle}`;
          const cached = sessionStorage.getItem(cacheKey);
          if (cached) {
            const tags = JSON.parse(cached);
            this._tagCache.set(handle, tags);
            return tags;
          }

          const response = await fetch(`/products/${handle}.js`, { credentials: 'same-origin' });
          if (!response.ok) return [];

          const data = await response.json();
          const tags = String(data.tags || '')
            .split(',')
            .map((tag) => tag.trim().toLowerCase())
            .filter(Boolean);

          sessionStorage.setItem(cacheKey, JSON.stringify(tags));
          this._tagCache.set(handle, tags);
          return tags;
        }

        _updateProgress(total) {
          const maxThreshold = parseInt(this.dataset.maxThreshold || '0', 10);
          const progress = maxThreshold > 0 ? Math.min(total / maxThreshold, 1) : 0;
          this.style.setProperty('--progress', `${Math.round(progress * 100)}%`);
          this.style.setProperty('--progress-scale', progress);
        }

        _updateMilestones(total) {
          const milestoneElements = Array.from(this.querySelectorAll('[data-reward-milestone]'));
          const markers = Array.from(this.querySelectorAll('[data-reward-marker]'));
          const message = this.querySelector('[data-rewards-message]');
          const maxThreshold = parseInt(this.dataset.maxThreshold || '0', 10);
          const unlockedSubtitle = this.dataset.allUnlockedSubtitle || 'You have unlocked all rewards!';

          const milestones = milestoneElements
            .map((el) => {
              const threshold = parseInt(el.dataset.threshold || '0', 10);
              const label = el.querySelector('.cart-rewards__label')?.textContent?.trim() || 'reward';
              const msg = el.dataset.message || 'Spend [amount_left] more to receive [reward]!';
              return { element: el, threshold, label, msg };
            })
            .filter((m) => m.threshold > 0)
            .sort((a, b) => a.threshold - b.threshold);

          milestones.forEach((m) => {
            m.element.classList.toggle('is-reached', total >= m.threshold);
          });

          markers.forEach((marker) => {
            const threshold = parseInt(marker.dataset.threshold || '0', 10);
            const reached = threshold > 0 && total >= threshold;
            marker.classList.toggle('is-reached', reached);
            if (maxThreshold > 0) {
              marker.style.left = `${Math.min(threshold / maxThreshold, 1) * 100}%`;
            }
          });

          /* Also update the start/end dots */
          const startDot = this.querySelector('.cart-rewards__endpoint--start');
          const endDot = this.querySelector('.cart-rewards__endpoint--end');
          if (startDot) startDot.classList.toggle('is-reached', total > 0);
          if (endDot) endDot.classList.toggle('is-reached', maxThreshold > 0 && total >= maxThreshold);

          const nextMilestone = milestones.find((m) => total < m.threshold);

          if (nextMilestone) {
            const remaining = Math.max(nextMilestone.threshold - total, 0);
            const tokens = {
              amount_left: this._formatMoney(remaining),
              amount: this._formatMoney(remaining),
              reward: nextMilestone.label,
              nearest_reward: nextMilestone.label
            };
            if (message) message.textContent = this._formatTemplate(nextMilestone.msg, tokens);
          } else {
            const lastLabel = milestones.length ? milestones[milestones.length - 1].label : 'reward';
            const tokens = { reward: lastLabel, nearest_reward: lastLabel };
            if (message) message.textContent = this._formatTemplate(unlockedSubtitle, tokens);
          }
        }

        _formatTemplate(template, tokens) {
          let output = String(template);
          Object.keys(tokens).forEach((key) => {
            const value = tokens[key];
            output = output
              .replace(new RegExp(`\\{\\{\\s*${key}\\s*\\}\\}`, 'g'), value)
              .replace(new RegExp(`\\[\\[\\s*${key}\\s*\\]\\]`, 'g'), value)
              .replace(new RegExp(`\\[\\s*${key}\\s*\\]`, 'g'), value)
              .replace(new RegExp(`\\{\\s*${key}\\s*\\}`, 'g'), value);
          });
          return output;
        }

        _clearPendingGifts(cartItems) {
          const cartGiftVariants = new Set(
            cartItems
              .map((item) => {
                if (!item.properties) return null;
                return item.properties.__reward_gift_variant || null;
              })
              .filter(Boolean)
          );

          this._pendingGiftAdds.forEach((variantId) => {
            if (cartGiftVariants.has(String(variantId))) {
              this._pendingGiftAdds.delete(variantId);
            }
          });
        }

        async _syncGifts(cart, total) {
          if (this._giftSyncInProgress || window.__cartRewardsSyncBusy) return;

          const isExcluded = this._isExcluded;
          const milestones = Array.from(this.querySelectorAll('[data-reward-milestone][data-type="gift"]'))
            .filter((milestone) => milestone.dataset.variantId);
          const cartItems = cart.items || [];

          if (!milestones.length) return;

          this._giftSyncInProgress = true;
          window.__cartRewardsSyncBusy = true;
          let didMutate = false;

          try {
            const desiredQuantities = new Map();
            const updates = {};

            for (const milestone of milestones) {
              const threshold = parseInt(milestone.dataset.threshold || '0', 10);
              const variantId = String(milestone.dataset.variantId);
              const shouldHaveGift = !isExcluded && total >= threshold;

              if (!desiredQuantities.has(variantId)) {
                desiredQuantities.set(variantId, 0);
              }

              if (shouldHaveGift) {
                desiredQuantities.set(variantId, desiredQuantities.get(variantId) + 1);
              }
            }

            for (const [variantId, desiredQty] of desiredQuantities.entries()) {
              const giftItems = cartItems.filter((item) => {
                if (!item.properties) return false;
                if (item.properties.__reward_gift_variant) {
                  return String(item.properties.__reward_gift_variant) === variantId;
                }
                return Boolean(item.properties.__reward_gift) && String(item.variant_id) === variantId;
              });

              if (desiredQty <= 0) {
                for (const item of giftItems) {
                  updates[item.key] = 0;
                }
                this._pendingGiftAdds.delete(variantId);
                continue;
              }

              if (giftItems.length === 0) {
                if (this._pendingGiftAdds.has(variantId)) {
                  continue;
                }

                this._pendingGiftAdds.add(variantId);
                await this._addGift(variantId, desiredQty);
                didMutate = true;
                continue;
              }

              const primaryItem = giftItems[0];
              const totalQty = giftItems.reduce((sum, item) => sum + item.quantity, 0);

              if (totalQty !== desiredQty || giftItems.length > 1) {
                updates[primaryItem.key] = desiredQty;
                for (const extraItem of giftItems.slice(1)) {
                  updates[extraItem.key] = 0;
                }
              }
            }

            if (Object.keys(updates).length > 0) {
              await this._updateGifts(updates);
              didMutate = true;
            }
          } finally {
            this._giftSyncInProgress = false;
            window.__cartRewardsSyncBusy = false;
          }

          if (didMutate) {
            await this._refreshDrawer();
          }
        }

        async _refreshDrawer() {
          try {
            /* Re-fetch the cart-drawer section HTML and swap it in */
            const [drawerResp, bubbleResp] = await Promise.all([
              fetch(`${Shopify.routes.root}?section_id=cart-drawer`),
              fetch(`${Shopify.routes.root}?section_id=cart-icon-bubble`)
            ]);

            const drawerHtml = await drawerResp.text();
            const bubbleHtml = await bubbleResp.text();

            /* Update cart drawer items + footer */
            const drawerDoc = new DOMParser().parseFromString(drawerHtml, 'text/html');
            const selectors = ['cart-drawer-items', '.cart-drawer__footer'];
            for (const sel of selectors) {
              const source = drawerDoc.querySelector(sel);
              const target = document.querySelector(sel);
              if (source && target) target.replaceWith(source);
            }

            /* Update cart icon bubble */
            const bubbleDoc = new DOMParser().parseFromString(bubbleHtml, 'text/html');
            const bubbleSource = bubbleDoc.querySelector('.shopify-section');
            const bubbleTarget = document.getElementById('cart-icon-bubble');
            if (bubbleSource && bubbleTarget) bubbleTarget.innerHTML = bubbleSource.innerHTML;

            /* Fire events so other scripts (BLOY, etc.) can react */
            document.dispatchEvent(new CustomEvent('cart:refresh'));
            if (window.__runRewardsLast) window.__runRewardsLast();
          } catch (e) {
            console.error('[cart-rewards] drawer refresh failed', e);
          }
        }

        async _addGift(variantId, quantity) {
          await fetch(`${Shopify.routes.root}cart/add.js`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({
              id: variantId,
              quantity,
              properties: { __reward_gift_variant: String(variantId) }
            })
          });
        }

        async _removeGift(lineKey) {
          await fetch(`${Shopify.routes.root}cart/change.js`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ id: lineKey, quantity: 0 })
          });
        }

        async _updateGiftQuantity(lineKey, quantity) {
          await fetch(`${Shopify.routes.root}cart/change.js`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ id: lineKey, quantity })
          });
        }

        async _updateGifts(updates) {
          await fetch(`${Shopify.routes.root}cart/update.js`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'same-origin',
            body: JSON.stringify({ updates })
          });
        }
      }

      window.customElements.define('cart-rewards', CartRewards);
    }
  </script>
{%- endif -%}
