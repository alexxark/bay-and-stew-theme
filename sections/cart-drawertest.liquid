<cart-drawer id="cart-drawer" class="cart-drawer drawer color-scheme color-scheme--{{ section.settings.color_scheme.id }}" initial-focus="false" handle-editor-events>
  <p class="h4" slot="header">{{ 'cart.general.title' | t }}</p>

  {%- liquid
    assign announcement_blocks = section.blocks | where: 'type', 'cart_announcement'
    assign announcement_count = 0

    for block in announcement_blocks
      if block.settings.text != blank
        assign announcement_count = announcement_count | plus: 1
      endif
    endfor
  -%}

  {%- if section.settings.show_cart_announcement and announcement_count > 0 -%}
    <div class="cart-announcement">
      {%- assign carousel_id = 'cart-announcement-' | append: section.id -%}
      <announcement-bar-carousel
        id="{{ carousel_id }}"
        class="cart-announcement__carousel"
        allow-swipe
        {% if announcement_count > 1 %}autoplay="{{ section.settings.cart_announcement_cycle_speed | default: 4 }}"{% endif %}
        aria-live="off"
        aria-roledescription="carousel"
      >
        {%- assign is_first = true -%}
        {%- for block in announcement_blocks -%}
          {%- if block.settings.text != blank -%}
            <div class="cart-announcement__item {% if is_first %}is-selected{% endif %}" {{ block.shopify_attributes }}>
              {{- block.settings.text -}}
            </div>
            {%- assign is_first = false -%}
          {%- endif -%}
        {%- endfor -%}
      </announcement-bar-carousel>
    </div>
  {%- endif -%}

  {%- if section.settings.show_rewards -%}
    {%- render 'cart-rewards' -%}
  {%- endif -%}

  <div class="cart-drawer__items">
    {%- if cart.empty? -%}
      <p class="text-subdued text-sm">{{ 'cart.general.empty' | t }}</p>
    {%- else -%}
      {%- for line_item in cart.items -%}
        {%- render 'line-item', line_item: line_item, show_quantity_selector: true -%}
      {%- endfor -%}
    {%- endif -%}
  </div>

  {%- liquid
      assign cross_sell_products_count = 0

      for product in section.settings.cross_sell_products
        assign items_for_product = cart | line_items_for: product

        if items_for_product.size == 0 and product.available
          assign cross_sell_products_count = cross_sell_products_count | plus: 1
        endif
      endfor
  -%}

  {%- if cart.empty? == false and cross_sell_products_count > 0 -%}
      <div class="cart-drawer__complementary-products complementary-products">
        {%- assign carousel_id = 'complementary-products-carousel-' | append: section.id -%}

        {%- if section.settings.cross_sell_title != blank or section.settings.cross_sell_stack_products == false and cross_sell_products_count > 1 -%}
          <div class="complementary-products__header complementary-products__header--align-start">
            <p class="h6">{{ section.settings.cross_sell_title }}</p>

            {%- if section.settings.cross_sell_stack_products == false and cross_sell_products_count > 1 -%}
              <carousel-navigation aria-controls="{{ carousel_id }}" class="page-dots page-dots--narrow">
                {%- for i in (1..cross_sell_products_count) -%}
                  <button type="button" class="relative" aria-current="{% if forloop.first %}true{% else %}false{% endif %}">
                    <span class="sr-only">{{ 'general.accessibility.go_to_item' | t: index: forloop.index }}</span>
                  </button>
                {%- endfor -%}
              </carousel-navigation>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- liquid
          capture complementary_products
            for product in section.settings.cross_sell_products
              assign products_in_cart = cart.items | where: 'product_id', product.id

              if products_in_cart.size == 0 and product.available
                render 'product-card-horizontal', product: product, show_quick_buy: true
              endif
            endfor
          endcapture
        -%}

        {%- if section.settings.cross_sell_stack_products -%}
          <div class="complementary-products__product-list">
            {{- complementary_products -}}
          </div>
        {%- else -%}
          <scroll-carousel id="{{ carousel_id }}" class="complementary-products__product-list complementary-products__product-list--carousel scroll-area bleed snap-x" aria-label="{{ section.settings.cross_sell_title | default: 'Complete with' | escape }}" aria-roledescription="carousel">
            {{- complementary_products -}}
          </scroll-carousel>
        {%- endif -%}
      </div>
  {%- endif -%}

  <form action="{{ routes.cart_url }}" method="POST" class="cart-drawer__footer" slot="footer">
      <input type="hidden" name="attributes[products_mobile_grid_mode]" value="">
      <input type="hidden" name="attributes[products_desktop_grid_mode]" value="">

      {%- if section.settings.show_cart_note or section.settings.show_shipping_text -%}
        <div class="v-stack gap-0.5 justify-items-start">
          {%- if section.settings.show_cart_note -%}
            {%- assign cart_note_dialog_id = 'cart-note-' | append: section.id -%}
            <button type="button" class="link-faded-reverse" aria-controls="{{ cart_note_dialog_id }}" aria-haspopup="dialog" aria-expanded="false">{{ 'cart.general.add_order_note' | t }}</button>

            <cart-note-dialog id="{{ cart_note_dialog_id }}" class="cart-drawer__order-note" aria-label="{{ 'cart.general.order_note' | t | escape }}">
              <div class="form">
                <cart-note class="form-control">
                  {%- assign order_note = 'cart.general.order_note' | t -%}
                  {%- assign placeholder = 'cart.general.note_placeholder' | t -%}
                  {%- render 'input', name: 'note', multiline: 3, label: order_note, value: cart.note, placeholder: placeholder, show_label_as_block: true -%}
                </cart-note>

                <dialog-close-button class="contents">
                  <button type="button" class="button">{{ 'cart.general.save_note' | t }}</button>
                </dialog-close-button>
              </div>
            </cart-note-dialog>
          {%- endif -%}

          {%- if section.settings.show_shipping_text -%}
            <p class="text-subdued">{{ 'cart.general.taxes_and_shipping_at_checkout' | t }}</p>
          {%- endif -%}
        </div>
      {%- endif -%}

      {% for discount_application in cart.cart_level_discount_applications %}
        <div class="h-stack justify-start gap-4">
          <span class="discount-badge text-xs">{%- render 'icon' with 'discount', width: 12 -%} {{- discount_application.title -}}</span>
          <span class="text-subdued">-{{ discount_application.total_allocated_amount | money }}</span>
        </div>
      {% endfor %}

      {%- if cart.empty? == false -%}
      <div class="button-group">
        {%- if section.settings.show_view_cart_button or section.settings.show_checkout_button == false -%}
          {%- assign view_cart = 'cart.general.view_cart' | t -%}
          {%- render 'button', href: routes.cart_url, content: view_cart, stretch: true -%}
        {%- endif -%}

        {%- if section.settings.show_checkout_button -%}
          {%- capture checkout_button -%}
            {{- 'cart.general.checkout' | t -}}

            {%- if section.settings.show_price_in_checkout_button -%}
              <span class="cart-drawer__button-price">{{- cart.total_price | money -}}</span>
            {%- endif -%}
          {%- endcapture -%}

          {%- render 'button', type: 'submit', content: checkout_button, name: 'checkout', stretch: true -%}
        {%- endif -%}
      </div>
      {%- endif -%}
  </form>
</cart-drawer>

{% schema %}
{
  "name": "t:sections.cart_drawer.name",
  "class": "shopify-section--cart-drawer",
  "tag": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.cart_drawer.page_info"
    },
    {
      "type": "paragraph",
      "content": "t:sections.cart_drawer.free_shipping_bar_info"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:global.colors.scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "t:sections.cart_drawer.show_cart_note",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_shipping_text",
      "label": "t:sections.cart_drawer.show_shipping_text",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_cart_button",
      "label": "t:sections.cart_drawer.show_view_cart_button",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_checkout_button",
      "label": "t:sections.cart_drawer.show_checkout_button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_price_in_checkout_button",
      "label": "t:sections.cart_drawer.show_price_in_checkout_button",
      "default": true
    },
    {
      "type": "header",
      "content": "Cart announcement"
    },
    {
      "type": "checkbox",
      "id": "show_cart_announcement",
      "label": "Show cart announcement",
      "default": true
    },
    {
      "type": "range",
      "id": "cart_announcement_cycle_speed",
      "label": "Announcement cycle speed (seconds)",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Gift message"
    },
    {
      "type": "checkbox",
      "id": "show_gift_message",
      "label": "Show gift message toggle",
      "default": true
    },
    {
      "type": "text",
      "id": "gift_message_toggle_label",
      "label": "Toggle label",
      "default": "Gift message ($0.95)"
    },
    {
      "type": "text",
      "id": "gift_message_label",
      "label": "Textarea label",
      "default": "Gift note to recipient"
    },
    {
      "type": "richtext",
      "id": "gift_message_help",
      "label": "Help text",
      "default": "<p>Your message will be printed on our Everly Made note card. This small fee helps cover printing and card stock, while adding a thoughtful touch to your gift.</p>"
    },
    {
      "type": "range",
      "id": "gift_message_rows",
      "label": "Textarea rows",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "header",
      "content": "Rewards"
    },
    {
      "type": "checkbox",
      "id": "show_rewards",
      "label": "Show rewards milestones",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_rewards_badge",
      "label": "Show rewards badge",
      "default": true
    },
    {
      "type": "text",
      "id": "rewards_free_shipping_threshold",
      "label": "Free shipping milestone (amount)",
      "default": "75"
    },
    {
      "type": "text",
      "id": "rewards_shipping_label",
      "label": "Free shipping label",
      "default": "Free Shipping"
    },
    {
      "type": "header",
      "content": "Perspective milestones"
    },
    {
      "type": "text",
      "id": "rewards_all_unlocked_subtitle",
      "label": "Subtitle post achieving all milestones",
      "default": "You have got [nearest_reward]"
    },
    {
      "type": "text",
      "id": "rewards_title_before_1",
      "label": "Title before achieving milestone 1",
      "default": "Spend [amount_left] more to receive [reward]!"
    },
    {
      "type": "text",
      "id": "rewards_title_before_2",
      "label": "Title before achieving milestone 2",
      "default": "Spend [amount_left] more to receive [reward]!"
    },
    {
      "type": "text",
      "id": "rewards_title_before_3",
      "label": "Title before achieving milestone 3",
      "default": "Spend [amount_left] more to receive [reward]!"
    },
    {
      "type": "text",
      "id": "rewards_title_before_4",
      "label": "Title before achieving milestone 4",
      "default": "Spend [amount_left] more to receive [reward]!"
    },
    {
      "type": "text",
      "id": "rewards_label_1",
      "label": "Reward 1",
      "default": "Free shipping!"
    },
    {
      "type": "text",
      "id": "rewards_label_2",
      "label": "Reward 2",
      "default": "Callia hair clip!"
    },
    {
      "type": "text",
      "id": "rewards_label_3",
      "label": "Reward 3",
      "default": "Mystery jewelry piece"
    },
    {
      "type": "text",
      "id": "rewards_label_4",
      "label": "Reward 4",
      "default": "Mystery jewelry piece"
    },
    {
      "type": "select",
      "id": "rewards_shipping_icon",
      "label": "Shipping milestone icon",
      "default": "picto-delivery-truck",
      "options": [
        { "value": "picto-delivery-truck", "label": "Delivery truck" },
        { "value": "picto-plane", "label": "Plane" },
        { "value": "picto-box", "label": "Box" },
        { "value": "picto-pin", "label": "Pin" }
      ]
    },
    {
      "type": "product",
      "id": "reward_gift_1_product",
      "label": "Reward gift 1 product"
    },
    {
      "type": "text",
      "id": "reward_gift_1_threshold",
      "label": "Reward gift 1 milestone (amount)",
      "default": "150"
    },
    {
      "type": "select",
      "id": "reward_gift_1_icon",
      "label": "Reward gift 1 icon",
      "default": "picto-gift",
      "options": [
        { "value": "picto-gift", "label": "Gift" },
        { "value": "picto-award-gift", "label": "Award gift" },
        { "value": "picto-coupon", "label": "Coupon" },
        { "value": "picto-star", "label": "Star" }
      ]
    },
    {
      "type": "product",
      "id": "reward_gift_2_product",
      "label": "Reward gift 2 product"
    },
    {
      "type": "text",
      "id": "reward_gift_2_threshold",
      "label": "Reward gift 2 milestone (amount)",
      "default": "200"
    },
    {
      "type": "select",
      "id": "reward_gift_2_icon",
      "label": "Reward gift 2 icon",
      "default": "picto-gift",
      "options": [
        { "value": "picto-gift", "label": "Gift" },
        { "value": "picto-award-gift", "label": "Award gift" },
        { "value": "picto-coupon", "label": "Coupon" },
        { "value": "picto-star", "label": "Star" }
      ]
    },
    {
      "type": "product",
      "id": "reward_gift_3_product",
      "label": "Reward gift 3 product"
    },
    {
      "type": "text",
      "id": "reward_gift_3_threshold",
      "label": "Reward gift 3 milestone (amount)",
      "default": "240"
    },
    {
      "type": "select",
      "id": "reward_gift_3_icon",
      "label": "Reward gift 3 icon",
      "default": "picto-gift",
      "options": [
        { "value": "picto-gift", "label": "Gift" },
        { "value": "picto-award-gift", "label": "Award gift" },
        { "value": "picto-coupon", "label": "Coupon" },
        { "value": "picto-star", "label": "Star" }
      ]
    },
    {
      "type": "header",
      "content": "t:sections.cart_drawer.cross_sell_category"
    },
    {
      "type": "product_list",
      "id": "cross_sell_products",
      "label": "t:sections.cart_drawer.cross_sell_products",
      "info": "t:sections.cart_drawer.cross_sell_products_info",
      "limit": 5
    },
    {
      "type": "inline_richtext",
      "id": "cross_sell_title",
      "label": "t:sections.cart_drawer.cross_sell_heading",
      "default": "Complete with"
    },
    {
      "type": "checkbox",
      "id": "cross_sell_stack_products",
      "label": "t:sections.cart_drawer.cross_sell_stack_products",
      "default": false
    }
  ],
  "blocks": [
    {
      "type": "cart_announcement",
      "name": "Cart announcement",
      "settings": [
        {
          "type": "richtext",
          "id": "text",
          "label": "Message"
        }
      ]
    }
  ],
  "max_blocks": 6
}
{% endschema %}